<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional PDF & Word Merger | Large File Support</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.worker.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- Notifications Container -->
    <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2 max-w-md"></div>
    
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-12">
            <div class="inline-flex items-center justify-center p-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl shadow-xl mb-6 animate-pulse">
                <i class="fas fa-file-contract text-white text-4xl"></i>
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">
                Professional PDF & Word Merger
            </h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">
                Merge PDF and Word documents with advanced page numbering. Supports files up to 
                <span class="font-bold text-blue-600 animate-bounce inline-block">400MB</span> 
                with intelligent chunk processing.
            </p>
            
            <!-- Memory Warning -->
            <div class="mt-8 max-w-3xl mx-auto bg-gradient-to-r from-red-50 to-orange-50 border-l-4 border-red-500 p-4 rounded-lg shadow-sm hidden" id="memoryWarning">
                <div class="flex items-start">
                    <i class="fas fa-exclamation-triangle text-red-500 text-xl mt-1 mr-3"></i>
                    <div class="flex-1">
                        <p class="font-bold text-red-700">Large File Processing Active</p>
                        <p class="text-red-600 text-sm mt-1">Large files will be processed in chunks to optimize memory usage.</p>
                        <div class="mt-3 flex items-center">
                            <div class="flex-1 bg-gray-200 rounded-full h-2 overflow-hidden">
                                <div id="memoryUsage" class="h-full bg-gradient-to-r from-green-400 via-yellow-400 to-red-500 rounded-full transition-all duration-300" style="width: 10%"></div>
                            </div>
                            <span class="text-xs font-medium ml-3" id="memoryText">Memory: Low</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Content -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- File Upload Card -->
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden transform transition-all duration-300 hover:shadow-2xl">
                        <div class="p-8 border-b border-gray-100">
                            <div class="flex items-center mb-6">
                                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gradient-to-r from-blue-100 to-purple-100 mr-4">
                                    <i class="fas fa-cloud-upload-alt text-blue-600 text-xl"></i>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-800">Upload Files</h2>
                                    <p class="text-gray-500">Drag & drop or click to browse</p>
                                </div>
                                <div class="ml-auto">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-gradient-to-r from-blue-500 to-purple-600 text-white animate-pulse">
                                        <i class="fas fa-bolt mr-1"></i>400MB Limit
                                    </span>
                                </div>
                            </div>
                            
                            <div class="border-3 border-dashed border-gray-300 bg-gradient-to-br from-gray-50 to-blue-50 rounded-2xl p-12 text-center cursor-pointer mb-6 transition-all duration-300 hover:border-blue-400 hover:shadow-lg" id="dropZone">
                                <div class="relative">
                                    <div class="w-24 h-24 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center mx-auto mb-6 shadow-inner">
                                        <i class="fas fa-file-import text-3xl text-blue-500"></i>
                                    </div>
                                    <div class="absolute -top-2 -right-2">
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-green-400 to-blue-500 flex items-center justify-center shadow-lg">
                                            <i class="fas fa-plus text-white text-sm"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <p class="text-xl font-semibold text-gray-700 mb-2">Drag & Drop Files Here</p>
                                <p class="text-gray-500 max-w-md mx-auto mb-6">
                                    Supported formats: <span class="font-bold">PDF, DOC, DOCX</span>. 
                                    Maximum <span class="font-bold">10 files</span> per session.
                                </p>
                                <div class="flex flex-wrap justify-center gap-4">
                                    <button id="addFilesBtn" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold rounded-xl shadow-md hover:shadow-lg transform hover:-translate-y-1 transition-all duration-200 flex items-center">
                                        <i class="fas fa-folder-open mr-2"></i>
                                        Browse Files
                                    </button>
                                    <button id="sampleFilesBtn" class="px-6 py-3 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 font-semibold rounded-xl shadow-md hover:shadow-lg transform hover:-translate-y-1 transition-all duration-200 flex items-center">
                                        <i class="fas fa-vial mr-2"></i>
                                        Try Sample
                                    </button>
                                </div>
                                
                                <input type="file" id="fileInput" class="hidden" accept=".pdf,.doc,.docx" multiple>
                            </div>
                            
                            <div class="flex flex-wrap justify-between items-center gap-4">
                                <div class="flex flex-wrap gap-3">
                                    <button id="clearFilesBtn" class="px-5 py-2.5 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 font-medium rounded-lg shadow hover:shadow-md transform hover:-translate-y-0.5 transition-all duration-200 flex items-center">
                                        <i class="fas fa-trash-alt mr-2"></i>
                                        Clear All
                                    </button>
                                    <button id="sortFilesBtn" class="px-5 py-2.5 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 font-medium rounded-lg shadow hover:shadow-md transform hover:-translate-y-0.5 transition-all duration-200 flex items-center">
                                        <i class="fas fa-sort-alpha-down mr-2"></i>
                                        Sort Files
                                    </button>
                                    <button id="reorderFilesBtn" class="px-5 py-2.5 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 font-medium rounded-lg shadow hover:shadow-md transform hover:-translate-y-0.5 transition-all duration-200 flex items-center">
                                        <i class="fas fa-random mr-2"></i>
                                        Reorder
                                    </button>
                                </div>
                                <div class="text-right">
                                    <p id="fileCount" class="text-xl font-bold text-gray-800">0 files</p>
                                    <p class="text-sm text-gray-500">Max 10 files, 400MB each</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- File List Section -->
                        <div class="p-8 border-b border-gray-100">
                            <div class="flex items-center mb-6">
                                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gradient-to-r from-blue-100 to-purple-100 mr-4">
                                    <i class="fas fa-list-ul text-blue-600 text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <h2 class="text-2xl font-bold text-gray-800">Selected Files</h2>
                                    <p class="text-gray-500" id="totalSize">Total size: 0 MB</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-bold text-gray-700">Total Pages: <span id="totalPages" class="text-blue-600">0</span></p>
                                </div>
                            </div>
                            
                            <div id="fileList" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                                <div class="text-center py-16" id="emptyState">
                                    <i class="fas fa-folder-open text-6xl text-gray-300 mb-6"></i>
                                    <p class="text-gray-500 text-xl font-medium mb-2">No files selected yet</p>
                                    <p class="text-gray-400">Drag and drop files or click "Browse Files"</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Options Section -->
                        <div class="p-8">
                            <div class="flex items-center mb-6">
                                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gradient-to-r from-blue-100 to-purple-100 mr-4">
                                    <i class="fas fa-sliders-h text-blue-600 text-xl"></i>
                                </div>
                                <h2 class="text-2xl font-bold text-gray-800">Merge Options</h2>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <!-- Page Numbering Options -->
                                <div>
                                    <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center">
                                        <i class="fas fa-sort-numeric-down mr-3 text-blue-500"></i>
                                        Page Numbering
                                    </h3>
                                    <div class="space-y-4">
                                        <label class="flex items-center p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 hover:bg-blue-50 cursor-pointer transition-all duration-200">
                                            <input type="radio" name="numbering" value="none" class="h-5 w-5 text-blue-600 mr-4" checked>
                                            <div>
                                                <span class="font-bold text-gray-700">No page numbers</span>
                                                <p class="text-sm text-gray-500 mt-1">Keep original pages without numbering</p>
                                            </div>
                                        </label>
                                        <label class="flex items-center p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 hover:bg-blue-50 cursor-pointer transition-all duration-200">
                                            <input type="radio" name="numbering" value="bottom-center" class="h-5 w-5 text-blue-600 mr-4">
                                            <div>
                                                <span class="font-bold text-gray-700">Bottom center</span>
                                                <p class="text-sm text-gray-500 mt-1">Classic centered page numbers</p>
                                            </div>
                                        </label>
                                        <label class="flex items-center p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 hover:bg-blue-50 cursor-pointer transition-all duration-200">
                                            <input type="radio" name="numbering" value="bottom-right" class="h-5 w-5 text-blue-600 mr-4">
                                            <div>
                                                <span class="font-bold text-gray-700">Bottom right</span>
                                                <p class="text-sm text-gray-500 mt-1">Standard right-aligned numbers</p>
                                            </div>
                                        </label>
                                        <label class="flex items-center p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 hover:bg-blue-50 cursor-pointer transition-all duration-200">
                                            <input type="radio" name="numbering" value="top-right" class="h-5 w-5 text-blue-600 mr-4">
                                            <div>
                                                <span class="font-bold text-gray-700">Top right</span>
                                                <p class="text-sm text-gray-500 mt-1">Header-style page numbers</p>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <div class="mt-8">
                                        <h4 class="font-bold text-gray-700 mb-3">Numbering Format</h4>
                                        <select id="numberFormat" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-200">
                                            <option value="1">1, 2, 3, ...</option>
                                            <option value="i">i, ii, iii, ...</option>
                                            <option value="I">I, II, III, ...</option>
                                            <option value="a">a, b, c, ...</option>
                                            <option value="A">A, B, C, ...</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Processing Options -->
                                <div>
                                    <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center">
                                        <i class="fas fa-cog mr-3 text-blue-500"></i>
                                        Processing Options
                                    </h3>
                                    <div class="space-y-4">
                                        <label class="flex items-start p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 hover:bg-blue-50 cursor-pointer transition-all duration-200">
                                            <input type="checkbox" id="preserveBookmarks" class="h-5 w-5 text-blue-600 mr-4 mt-1" checked>
                                            <div>
                                                <span class="font-bold text-gray-700">Preserve bookmarks</span>
                                                <p class="text-sm text-gray-500 mt-1">Keep existing PDF bookmarks and outlines</p>
                                            </div>
                                        </label>
                                        <label class="flex items-start p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 hover:bg-blue-50 cursor-pointer transition-all duration-200">
                                            <input type="checkbox" id="preserveForms" class="h-5 w-5 text-blue-600 mr-4 mt-1" checked>
                                            <div>
                                                <span class="font-bold text-gray-700">Preserve form fields</span>
                                                <p class="text-sm text-gray-500 mt-1">Keep interactive form elements</p>
                                            </div>
                                        </label>
                                        <label class="flex items-start p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 hover:bg-blue-50 cursor-pointer transition-all duration-200">
                                            <input type="checkbox" id="autoConvertWord" class="h-5 w-5 text-blue-600 mr-4 mt-1" checked>
                                            <div>
                                                <span class="font-bold text-gray-700">Auto-convert Word to PDF</span>
                                                <p class="text-sm text-gray-500 mt-1">Convert Word documents automatically</p>
                                            </div>
                                        </label>
                                        <label class="flex items-start p-4 rounded-xl border-2 border-gray-200 hover:border-blue-300 hover:bg-blue-50 cursor-pointer transition-all duration-200">
                                            <input type="checkbox" id="optimizeLargeFiles" class="h-5 w-5 text-blue-600 mr-4 mt-1" checked>
                                            <div>
                                                <span class="font-bold text-gray-700">Optimize large files</span>
                                                <p class="text-sm text-gray-500 mt-1">Chunk processing for files > 50MB</p>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <div class="mt-8">
                                        <h4 class="font-bold text-gray-700 mb-3">Output Quality</h4>
                                        <select id="outputQuality" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-200">
                                            <option value="high">High (Best quality)</option>
                                            <option value="medium" selected>Medium (Recommended)</option>
                                            <option value="low">Low (Smaller file size)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar -->
                <div class="lg:col-span-1 space-y-8">
                    <!-- Progress Section -->
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden transform transition-all duration-300 hidden" id="progressSection">
                        <div class="p-6 border-b border-gray-100">
                            <div class="flex items-center mb-6">
                                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gradient-to-r from-blue-100 to-purple-100 mr-4">
                                    <i class="fas fa-tasks text-blue-600 text-xl"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800">Processing Status</h3>
                            </div>
                            
                            <div class="mb-8">
                                <div class="flex justify-between mb-3">
                                    <span id="progressText" class="font-bold text-gray-700">Initializing...</span>
                                    <span id="progressPercent" class="font-bold text-blue-600 text-xl">0%</span>
                                </div>
                                <div class="relative">
                                    <div class="overflow-hidden h-3 mb-4 text-xs flex rounded-full bg-gray-200">
                                        <div id="progressFill" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-blue-500 to-purple-600 transition-all duration-500" style="width: 0%"></div>
                                    </div>
                                    <div class="absolute top-0 left-0 w-full h-3">
                                        <div class="h-full w-full bg-gradient-to-r from-transparent via-white to-transparent opacity-30 animate-slide"></div>
                                    </div>
                                </div>
                                <div class="text-center mt-2">
                                    <p id="chunkProgress" class="text-sm text-gray-500"></p>
                                </div>
                            </div>
                            
                            <div class="space-y-6" id="processSteps">
                                <div class="process-step active relative">
                                    <div class="step-icon absolute left-0 top-0 w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold text-sm z-10">1</div>
                                    <div class="ml-12">
                                        <p class="font-bold text-gray-700">Preparing files</p>
                                        <p class="text-sm text-gray-500">Analyzing document structure</p>
                                    </div>
                                </div>
                                <div class="process-step relative">
                                    <div class="step-icon absolute left-0 top-0 w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-sm z-10">2</div>
                                    <div class="ml-12">
                                        <p class="font-bold text-gray-700">Converting documents</p>
                                        <p class="text-sm text-gray-500">Word to PDF conversion</p>
                                    </div>
                                </div>
                                <div class="process-step relative">
                                    <div class="step-icon absolute left-0 top-0 w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-sm z-10">3</div>
                                    <div class="ml-12">
                                        <p class="font-bold text-gray-700">Merging pages</p>
                                        <p class="text-sm text-gray-500">Combining all documents</p>
                                    </div>
                                </div>
                                <div class="process-step relative">
                                    <div class="step-icon absolute left-0 top-0 w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-sm z-10">4</div>
                                    <div class="ml-12">
                                        <p class="font-bold text-gray-700">Adding page numbers</p>
                                        <p class="text-sm text-gray-500">Applying formatting</p>
                                    </div>
                                </div>
                                <div class="process-step relative">
                                    <div class="step-icon absolute left-0 top-0 w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-sm z-10">5</div>
                                    <div class="ml-12">
                                        <p class="font-bold text-gray-700">Finalizing output</p>
                                        <p class="text-sm text-gray-500">Creating download file</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6 bg-gradient-to-r from-gray-50 to-blue-50">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-gray-700" id="statusText">Ready to process</p>
                                    <p class="text-sm text-gray-500">Estimated time: <span id="estimateTime" class="font-bold">Calculating...</span></p>
                                </div>
                                <button id="cancelBtn" class="px-4 py-2 bg-gradient-to-r from-gray-200 to-gray-300 text-gray-700 font-medium rounded-lg shadow hover:shadow-md transform hover:-translate-y-0.5 transition-all duration-200 flex items-center">
                                    <i class="fas fa-times mr-2"></i>
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Card -->
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden transform transition-all duration-300 hover:shadow-2xl sticky top-8">
                        <div class="p-8">
                            <div class="text-center mb-8">
                                <div class="relative inline-block mb-6">
                                    <div class="w-24 h-24 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center mx-auto shadow-inner">
                                        <i class="fas fa-file-contract text-3xl text-blue-500"></i>
                                    </div>
                                    <div class="absolute -bottom-2 -right-2">
                                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-green-400 to-blue-500 flex items-center justify-center shadow-lg animate-bounce">
                                            <i class="fas fa-magic text-white text-lg"></i>
                                        </div>
                                    </div>
                                </div>
                                <h3 class="text-2xl font-bold text-gray-800 mb-2">Merge & Process</h3>
                                <p class="text-gray-500">Create a single document with all your files</p>
                            </div>
                            
                            <div class="space-y-4 mb-8">
                                <div class="flex justify-between items-center p-4 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl">
                                    <span class="text-gray-700 font-medium">Total Files:</span>
                                    <span id="sidebarFileCount" class="font-bold text-xl text-blue-600">0</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl">
                                    <span class="text-gray-700 font-medium">Total Pages:</span>
                                    <span id="sidebarTotalPages" class="font-bold text-xl text-blue-600">0</span>
                                </div>
                                <div class="flex justify-between items-center p-4 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl">
                                    <span class="text-gray-700 font-medium">Total Size:</span>
                                    <span id="sidebarTotalSize" class="font-bold text-xl text-blue-600">0 MB</span>
                                </div>
                            </div>
                            
                            <button id="processBtn" class="w-full px-6 py-4 bg-gradient-to-r from-green-500 to-green-600 text-white font-bold text-lg rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:transform-none" disabled>
                                <i class="fas fa-magic mr-3"></i>
                                Merge & Process Files
                            </button>
                            
                            <div class="mt-6 text-center">
                                <p class="text-xs text-gray-400 flex items-center justify-center">
                                    <i class="fas fa-shield-alt mr-2"></i>
                                    All processing happens locally in your browser
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tips Card -->
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl shadow-xl p-6 transform transition-all duration-300 hover:shadow-lg">
                        <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-lightbulb text-yellow-500 text-xl mr-3"></i>
                            Pro Tips
                        </h4>
                        <ul class="space-y-3">
                            <li class="flex items-start">
                                <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                                <span class="text-gray-600">Large files (>50MB) are automatically processed in chunks</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                                <span class="text-gray-600">Drag files to reorder them before merging</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                                <span class="text-gray-600">Use "Medium" quality for best balance</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="mt-12 text-center">
                <p class="text-gray-500 flex flex-wrap items-center justify-center gap-2">
                    <span class="inline-flex items-center">
                        <i class="fas fa-lock mr-2"></i> Secure local processing
                    </span>
                    <span class="hidden md:inline">•</span>
                    <span class="inline-flex items-center">
                        <i class="fas fa-upload mr-2"></i> No file uploads
                    </span>
                    <span class="hidden md:inline">•</span>
                    <span class="inline-flex items-center">
                        <i class="fas fa-database mr-2"></i> Supports up to 400MB
                    </span>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedFiles = [];
        const maxFiles = 10;
        const maxFileSize = 400 * 1024 * 1024; // 400MB in bytes
        let isProcessing = false;
        let processingCancelled = false;
        
        // Performance optimization
        const CHUNK_SIZE = 20 * 1024 * 1024; // 20MB chunks for large files
        const MAX_MEMORY_PAGES = 500;

        // DOM elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const addFilesBtn = document.getElementById('addFilesBtn');
        const clearFilesBtn = document.getElementById('clearFilesBtn');
        const sortFilesBtn = document.getElementById('sortFilesBtn');
        const reorderFilesBtn = document.getElementById('reorderFilesBtn');
        const sampleFilesBtn = document.getElementById('sampleFilesBtn');
        const fileList = document.getElementById('fileList');
        const fileCount = document.getElementById('fileCount');
        const emptyState = document.getElementById('emptyState');
        const processBtn = document.getElementById('processBtn');
        const progressSection = document.getElementById('progressSection');
        const progressText = document.getElementById('progressText');
        const progressPercent = document.getElementById('progressPercent');
        const progressFill = document.getElementById('progressFill');
        const statusText = document.getElementById('statusText');
        const cancelBtn = document.getElementById('cancelBtn');
        const memoryWarning = document.getElementById('memoryWarning');
        const memoryUsage = document.getElementById('memoryUsage');
        const memoryText = document.getElementById('memoryText');
        const totalSizeElement = document.getElementById('totalSize');
        const sidebarFileCount = document.getElementById('sidebarFileCount');
        const sidebarTotalSize = document.getElementById('sidebarTotalSize');
        const sidebarTotalPages = document.getElementById('sidebarTotalPages');
        const totalPages = document.getElementById('totalPages');
        const chunkProgress = document.getElementById('chunkProgress');
        const estimateTime = document.getElementById('estimateTime');
        const processSteps = document.getElementById('processSteps');
        const notifications = document.getElementById('notifications');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addFilesBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            clearFilesBtn.addEventListener('click', clearAllFiles);
            sortFilesBtn.addEventListener('click', sortFilesByName);
            reorderFilesBtn.addEventListener('click', toggleReorderMode);
            sampleFilesBtn.addEventListener('click', loadSampleFiles);
            processBtn.addEventListener('click', processFiles);
            cancelBtn.addEventListener('click', cancelProcessing);
            
            // Drag and drop events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-400', 'bg-blue-50');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-400', 'bg-blue-50');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-400', 'bg-blue-50');
                
                if (e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files);
                }
            });
            
            // Update memory usage
            setInterval(updateMemoryUsage, 2000);
            updateMemoryUsage();
            
            // Initialize sortable file list
            initSortableFileList();
            
            // Add CSS for animations
            addAnimationStyles();
        });

        // Handle file selection from input
        function handleFileSelect(e) {
            handleFiles(e.target.files);
            fileInput.value = '';
        }

        // Process selected files
        function handleFiles(files) {
            if (selectedFiles.length + files.length > maxFiles) {
                showNotification(`You can only select up to ${maxFiles} files.`, 'error');
                return;
            }
            
            let largeFileDetected = false;
            let newFilesAdded = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (!isValidFileType(file)) {
                    showNotification(`${file.name} is not a PDF or Word file.`, 'error');
                    continue;
                }
                
                if (file.size > maxFileSize) {
                    showNotification(`${file.name} is too large. Maximum file size is 400MB.`, 'error');
                    continue;
                }
                
                if (file.size > 50 * 1024 * 1024) {
                    largeFileDetected = true;
                }
                
                if (!selectedFiles.some(f => f.name === file.name && f.size === file.size && f.lastModified === file.lastModified)) {
                    selectedFiles.push({
                        file: file,
                        id: Date.now() + Math.random(),
                        order: selectedFiles.length,
                        type: getFileType(file)
                    });
                    newFilesAdded++;
                }
            }
            
            if (newFilesAdded > 0) {
                updateFileList();
                showNotification(`Added ${newFilesAdded} file${newFilesAdded > 1 ? 's' : ''}`, 'success');
                
                if (largeFileDetected) {
                    memoryWarning.classList.remove('hidden');
                    showNotification('Large file detected. Optimized processing will be used.', 'info');
                }
            }
        }

        // Check if file is PDF or Word
        function isValidFileType(file) {
            const validTypes = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            ];
            return validTypes.includes(file.type) || 
                   file.name.endsWith('.pdf') || 
                   file.name.endsWith('.doc') || 
                   file.name.endsWith('.docx');
        }

        // Get file type
        function getFileType(file) {
            if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) return 'pdf';
            if (file.type === 'application/msword' || file.name.endsWith('.doc') || 
                file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || 
                file.name.endsWith('.docx')) return 'word';
            return 'unknown';
        }

        // Update file list UI
        function updateFileList() {
            fileList.innerHTML = '';
            
            if (selectedFiles.length === 0) {
                fileList.appendChild(emptyState);
                emptyState.classList.remove('hidden');
                fileCount.textContent = '0 files';
                sidebarFileCount.textContent = '0';
                sidebarTotalSize.textContent = '0 MB';
                sidebarTotalPages.textContent = '0';
                totalPages.textContent = '0';
                processBtn.disabled = true;
                totalSizeElement.textContent = 'Total size: 0 MB';
                return;
            }
            
            emptyState.classList.add('hidden');
            fileCount.textContent = `${selectedFiles.length} file${selectedFiles.length > 1 ? 's' : ''}`;
            sidebarFileCount.textContent = selectedFiles.length;
            processBtn.disabled = false;
            
            let totalSize = 0;
            selectedFiles.forEach(item => {
                totalSize += item.file.size;
            });
            
            const formattedTotalSize = formatFileSize(totalSize);
            totalSizeElement.textContent = `Total size: ${formattedTotalSize}`;
            sidebarTotalSize.textContent = formatFileSize(totalSize, true);
            
            selectedFiles.sort((a, b) => a.order - b.order);
            
            selectedFiles.forEach((item, index) => {
                const file = item.file;
                const fileId = item.id;
                const fileType = item.type;
                const fileSize = file.size;
                const sizeBadgeClass = getSizeBadgeClass(fileSize);
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl p-4 hover:from-blue-50 hover:to-purple-50 transition-all duration-200 transform hover:-translate-y-1 hover:shadow-md';
                fileItem.dataset.id = fileId;
                fileItem.setAttribute('draggable', 'true');
                
                fileItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="drag-handle mr-3 cursor-move text-gray-400 hover:text-blue-500 transition-colors">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                            <div class="flex items-center">
                                ${fileType === 'pdf' ? 
                                    `<div class="w-12 h-12 rounded-lg bg-gradient-to-br from-red-100 to-red-200 flex items-center justify-center mr-4 shadow-sm">
                                        <i class="fas fa-file-pdf text-xl text-red-500"></i>
                                    </div>` :
                                    `<div class="w-12 h-12 rounded-lg bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center mr-4 shadow-sm">
                                        <i class="fas fa-file-word text-xl text-blue-500"></i>
                                    </div>`
                                }
                                <div class="max-w-xs">
                                    <p class="font-bold text-gray-800 truncate">${file.name}</p>
                                    <div class="flex items-center mt-1 space-x-2">
                                        <span class="text-xs font-bold px-2 py-1 rounded ${fileType === 'pdf' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">
                                            ${fileType === 'pdf' ? 'PDF' : 'WORD'}
                                        </span>
                                        <span class="text-xs text-gray-500">${formatFileSize(fileSize)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="text-xs font-bold px-2 py-1 rounded-full ${sizeBadgeClass === 'large' ? 'bg-red-100 text-red-800' : sizeBadgeClass === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                ${getSizeCategory(fileSize)}
                            </span>
                            <button class="remove-file text-gray-400 hover:text-red-500 transition-colors p-2" data-id="${fileId}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                fileList.appendChild(fileItem);
            });
            
            document.querySelectorAll('.remove-file').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const fileId = this.getAttribute('data-id');
                    removeFile(fileId);
                });
            });
            
            updateTotalPagesEstimate();
        }

        // Get size category
        function getSizeCategory(sizeInBytes) {
            const sizeInMB = sizeInBytes / (1024 * 1024);
            if (sizeInMB > 100) return 'Large';
            if (sizeInMB > 10) return 'Medium';
            return 'Small';
        }

        // Get size badge class
        function getSizeBadgeClass(sizeInBytes) {
            const sizeInMB = sizeInBytes / (1024 * 1024);
            if (sizeInMB > 100) return 'large';
            if (sizeInMB > 10) return 'medium';
            return 'small';
        }

        // Remove file
        function removeFile(fileId) {
            const index = selectedFiles.findIndex(item => item.id == fileId);
            if (index !== -1) {
                selectedFiles.splice(index, 1);
                updateFileList();
                showNotification('File removed', 'info');
            }
        }

        // Clear all files
        function clearAllFiles() {
            if (selectedFiles.length === 0) return;
            
            if (confirm(`Are you sure you want to remove all ${selectedFiles.length} files?`)) {
                selectedFiles = [];
                updateFileList();
                showNotification('All files cleared', 'info');
                memoryWarning.classList.add('hidden');
            }
        }

        // Sort files by name
        function sortFilesByName() {
            selectedFiles.sort((a, b) => {
                return a.file.name.localeCompare(b.file.name);
            });
            
            selectedFiles.forEach((item, index) => {
                item.order = index;
            });
            
            updateFileList();
            showNotification('Files sorted alphabetically', 'success');
        }

        // Toggle reorder mode
        function toggleReorderMode() {
            const dragHandles = document.querySelectorAll('.drag-handle');
            dragHandles.forEach(handle => {
                if (handle.style.display === 'none') {
                    handle.style.display = 'block';
                    showNotification('Reorder mode enabled. Drag files to rearrange.', 'info');
                } else {
                    handle.style.display = 'none';
                    showNotification('Reorder mode disabled', 'info');
                }
            });
        }

        // Load sample files
        function loadSampleFiles() {
            showNotification('Loading sample files...', 'info');
            
            setTimeout(() => {
                const sampleFiles = [
                    { name: 'Sample-Document.pdf', size: 2.5 * 1024 * 1024, type: 'application/pdf' },
                    { name: 'Annual-Report.docx', size: 1.8 * 1024 * 1024, type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' },
                    { name: 'Research-Paper.pdf', size: 3.2 * 1024 * 1024, type: 'application/pdf' }
                ];
                
                sampleFiles.forEach(sample => {
                    const file = new File([new ArrayBuffer(sample.size)], sample.name, { type: sample.type });
                    selectedFiles.push({
                        file: file,
                        id: Date.now() + Math.random(),
                        order: selectedFiles.length,
                        type: getFileType(file)
                    });
                });
                
                updateFileList();
                showNotification('Sample files loaded successfully!', 'success');
            }, 1000);
        }

        // Initialize sortable file list
        function initSortableFileList() {
            let draggedItem = null;
            
            fileList.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('drag-handle') || e.target.closest('.drag-handle')) {
                    draggedItem = e.target.closest('.file-item');
                    setTimeout(() => {
                        draggedItem.classList.add('opacity-50');
                    }, 0);
                }
            });
            
            fileList.addEventListener('dragend', (e) => {
                if (draggedItem) {
                    draggedItem.classList.remove('opacity-50');
                    draggedItem = null;
                }
            });
            
            fileList.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(fileList, e.clientY);
                const draggable = draggedItem;
                
                if (afterElement == null) {
                    fileList.appendChild(draggable);
                } else {
                    fileList.insertBefore(draggable, afterElement);
                }
                
                Array.from(fileList.children).forEach((child, index) => {
                    if (child.classList.contains('file-item')) {
                        const fileId = child.dataset.id;
                        const fileIndex = selectedFiles.findIndex(item => item.id == fileId);
                        if (fileIndex !== -1) {
                            selectedFiles[fileIndex].order = index;
                        }
                    }
                });
            });
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.file-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Format file size
        function formatFileSize(bytes, short = false) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = short ? ['B', 'KB', 'MB', 'GB'] : ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            const value = parseFloat((bytes / Math.pow(k, i)).toFixed(2));
            
            if (short && i === 2 && value < 1) return '<1 MB';
            return value + ' ' + sizes[i];
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `bg-white rounded-xl shadow-lg p-4 border-l-4 transform transition-all duration-300 ${type === 'success' ? 'border-green-500' : type === 'error' ? 'border-red-500' : 'border-blue-500'} animate-slideInRight`;
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        ${type === 'success' ? 
                            '<i class="fas fa-check-circle text-green-500 text-xl"></i>' :
                          type === 'error' ?
                            '<i class="fas fa-exclamation-circle text-red-500 text-xl"></i>' :
                            '<i class="fas fa-info-circle text-blue-500 text-xl"></i>'
                        }
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-bold text-gray-900">${message}</p>
                    </div>
                    <button class="ml-3 close-notification">
                        <i class="fas fa-times text-gray-400 hover:text-gray-600"></i>
                    </button>
                </div>
            `;
            
            notifications.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.add('opacity-0', 'translate-x-full');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 5000);
            
            notification.querySelector('.close-notification').addEventListener('click', () => {
                notification.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            });
        }

        // Update memory usage
        function updateMemoryUsage() {
            let totalSize = 0;
            selectedFiles.forEach(item => {
                totalSize += item.file.size;
            });
            
            const memoryEstimate = totalSize > 0 ? Math.min(100, (totalSize / (200 * 1024 * 1024)) * 100) : 10;
            memoryUsage.style.width = `${memoryEstimate}%`;
            
            if (memoryEstimate > 70) {
                memoryText.textContent = 'Memory: High';
                memoryText.className = 'text-xs font-bold text-red-600 ml-3';
            } else if (memoryEstimate > 40) {
                memoryText.textContent = 'Memory: Medium';
                memoryText.className = 'text-xs font-bold text-yellow-600 ml-3';
            } else {
                memoryText.textContent = 'Memory: Low';
                memoryText.className = 'text-xs font-bold text-green-600 ml-3';
            }
        }

        // Update total pages estimate
        async function updateTotalPagesEstimate() {
            let totalEstimatedPages = 0;
            
            for (const item of selectedFiles) {
                const file = item.file;
                const fileType = item.type;
                
                if (fileType === 'pdf') {
                    const estimatedPages = Math.max(1, Math.ceil(file.size / (50 * 1024)));
                    totalEstimatedPages += estimatedPages;
                } else {
                    const estimatedPages = Math.max(1, Math.ceil(file.size / (30 * 1024)));
                    totalEstimatedPages += estimatedPages;
                }
            }
            
            sidebarTotalPages.textContent = totalEstimatedPages;
            totalPages.textContent = totalEstimatedPages;
            updateTimeEstimate();
        }

        // Update time estimate
        function updateTimeEstimate() {
            let totalSize = 0;
            selectedFiles.forEach(item => {
                totalSize += item.file.size;
            });
            
            const sizeInMB = totalSize / (1024 * 1024);
            let estimateSeconds = 0;
            
            if (sizeInMB > 200) {
                estimateSeconds = 120 + (sizeInMB - 200) / 10;
            } else if (sizeInMB > 100) {
                estimateSeconds = 60 + (sizeInMB - 100) / 5;
            } else if (sizeInMB > 50) {
                estimateSeconds = 30 + (sizeInMB - 50) / 3;
            } else if (sizeInMB > 10) {
                estimateSeconds = 10 + (sizeInMB - 10) / 2;
            } else {
                estimateSeconds = Math.max(5, sizeInMB / 2);
            }
            
            const wordFiles = selectedFiles.filter(item => item.type === 'word').length;
            estimateSeconds += wordFiles * 5;
            
            if (estimateSeconds < 60) {
                estimateTime.textContent = `${Math.ceil(estimateSeconds)} seconds`;
            } else {
                estimateTime.textContent = `${Math.ceil(estimateSeconds / 60)} minutes`;
            }
        }

        // Process files
        async function processFiles() {
            if (selectedFiles.length === 0) {
                showNotification('Please select at least one file.', 'error');
                return;
            }
            
            if (isProcessing) {
                showNotification('Processing is already in progress.', 'info');
                return;
            }
            
            isProcessing = true;
            processingCancelled = false;
            
            progressSection.classList.remove('hidden');
            progressSection.classList.add('animate-fadeIn');
            processBtn.disabled = true;
            
            progressFill.style.width = '0%';
            progressPercent.textContent = '0%';
            progressText.textContent = 'Initializing...';
            statusText.textContent = 'Starting processing...';
            chunkProgress.textContent = '';
            
            const steps = processSteps.querySelectorAll('.process-step');
            steps.forEach(step => {
                step.classList.remove('active', 'completed');
                const icon = step.querySelector('.step-icon');
                icon.className = 'step-icon absolute left-0 top-0 w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-sm z-10';
            });
            steps[0].classList.add('active');
            steps[0].querySelector('.step-icon').className = 'step-icon absolute left-0 top-0 w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold text-sm z-10';
            
            try {
                const numberingOption = document.querySelector('input[name="numbering"]:checked').value;
                const numberFormat = document.getElementById('numberFormat').value;
                const optimizeLargeFiles = document.getElementById('optimizeLargeFiles').checked;
                const outputQuality = document.getElementById('outputQuality').value;
                
                // Step 1: Preparing files
                updateProcessStep(0, true);
                progressText.textContent = 'Analyzing file structure...';
                
                const { PDFDocument } = PDFLib;
                const mergedPdf = await PDFDocument.create();
                
                // Step 2: Processing files
                updateProcessStep(1, true);
                
                let currentPage = 0;
                let totalProcessedPages = 0;
                let totalPagesToProcess = 0;
                
                // First pass: count pages
                for (const item of selectedFiles) {
                    const file = item.file;
                    const fileType = item.type;
                    
                    if (fileType === 'pdf') {
                        try {
                            const arrayBuffer = await readFileAsArrayBuffer(file);
                            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                            totalPagesToProcess += pdf.numPages;
                            pdf.destroy();
                        } catch (error) {
                            totalPagesToProcess += Math.max(1, Math.ceil(file.size / (50 * 1024)));
                        }
                    } else {
                        totalPagesToProcess += Math.max(1, Math.ceil(file.size / (30 * 1024)));
                    }
                }
                
                // Process each file
                for (let i = 0; i < selectedFiles.length; i++) {
                    if (processingCancelled) throw new Error('Processing cancelled');
                    
                    const item = selectedFiles[i];
                    const file = item.file;
                    const fileType = item.type;
                    
                    progressText.textContent = `Processing ${file.name}...`;
                    
                    if (fileType === 'pdf') {
                        const shouldChunk = optimizeLargeFiles && file.size > 50 * 1024 * 1024;
                        
                        if (shouldChunk) {
                            await processLargePdf(file, mergedPdf, numberingOption, numberFormat, (pageNum, total) => {
                                currentPage++;
                                totalProcessedPages++;
                                const progress = Math.round((totalProcessedPages / totalPagesToProcess) * 100);
                                progressFill.style.width = `${progress}%`;
                                progressPercent.textContent = `${progress}%`;
                                chunkProgress.textContent = `Processing chunk ${pageNum}/${total}`;
                            });
                        } else {
                            const fileBytes = await readFileAsArrayBuffer(file);
                            const pdfDoc = await PDFDocument.load(fileBytes);
                            const pages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                            
                            for (let j = 0; j < pages.length; j++) {
                                if (processingCancelled) throw new Error('Processing cancelled');
                                
                                const page = pages[j];
                                currentPage++;
                                totalProcessedPages++;
                                
                                if (numberingOption !== 'none') {
                                    await addPageNumber(page, currentPage, numberFormat, numberingOption, mergedPdf);
                                }
                                
                                mergedPdf.addPage(page);
                                
                                const progress = Math.round((totalProcessedPages / totalPagesToProcess) * 100);
                                progressFill.style.width = `${progress}%`;
                                progressPercent.textContent = `${progress}%`;
                            }
                        }
                    } else {
                        // Convert Word to PDF
                        const pdfBytes = await convertWordToPdf(file);
                        const pdfDoc = await PDFDocument.load(pdfBytes);
                        const pages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                        
                        for (let j = 0; j < pages.length; j++) {
                            if (processingCancelled) throw new Error('Processing cancelled');
                            
                            const page = pages[j];
                            currentPage++;
                            totalProcessedPages++;
                            
                            if (numberingOption !== 'none') {
                                await addPageNumber(page, currentPage, numberFormat, numberingOption, mergedPdf);
                            }
                            
                            mergedPdf.addPage(page);
                            
                            const progress = Math.round((totalProcessedPages / totalPagesToProcess) * 100);
                            progressFill.style.width = `${progress}%`;
                            progressPercent.textContent = `${progress}%`;
                        }
                    }
                }
                
                // Step 3: Finalizing
                updateProcessStep(3, true);
                updateProcessStep(4, true);
                progressText.textContent = 'Finalizing merged document...';
                progressFill.style.width = '95%';
                progressPercent.textContent = '95%';
                
                // Set metadata
                mergedPdf.setTitle('Merged Document');
                mergedPdf.setAuthor('PDF Merger Tool');
                mergedPdf.setCreationDate(new Date());
                
                // Save with quality settings
                let saveOptions = {};
                if (outputQuality === 'low') {
                    saveOptions = { useObjectStreams: false };
                } else if (outputQuality === 'medium') {
                    saveOptions = { useObjectStreams: true };
                }
                
                const mergedPdfBytes = await mergedPdf.save(saveOptions);
                
                // Mark all steps as completed
                steps.forEach(step => {
                    step.classList.add('completed');
                    step.classList.remove('active');
                    const icon = step.querySelector('.step-icon');
                    icon.className = 'step-icon absolute left-0 top-0 w-8 h-8 rounded-full bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center text-white font-bold text-sm z-10';
                });
                
                // Step 5: Download
                progressText.textContent = 'Preparing download...';
                progressFill.style.width = '100%';
                progressPercent.textContent = '100%';
                
                // Create download
                const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `merged-document-${new Date().toISOString().slice(0, 10)}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`Merged document downloaded successfully! ${currentPage} pages merged.`, 'success');
                statusText.textContent = 'Processing complete! File downloaded.';
                
                setTimeout(() => {
                    resetProcessingUI();
                }, 3000);
                
            } catch (error) {
                console.error('Error processing files:', error);
                
                if (error.message === 'Processing cancelled') {
                    showNotification('Processing was cancelled.', 'info');
                    statusText.textContent = 'Processing cancelled.';
                } else {
                    showNotification(`Error: ${error.message}`, 'error');
                    statusText.textContent = 'Error processing files. Please try again.';
                }
                
                resetProcessingUI();
            }
        }

        // Update process step
        function updateProcessStep(stepIndex, isActive = false) {
            const steps = processSteps.querySelectorAll('.process-step');
            
            if (isActive) {
                for (let i = 0; i < stepIndex; i++) {
                    steps[i].classList.add('completed');
                    steps[i].classList.remove('active');
                    const icon = steps[i].querySelector('.step-icon');
                    icon.className = 'step-icon absolute left-0 top-0 w-8 h-8 rounded-full bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center text-white font-bold text-sm z-10';
                }
                
                steps[stepIndex].classList.add('active');
                steps[stepIndex].classList.remove('completed');
                const icon = steps[stepIndex].querySelector('.step-icon');
                icon.className = 'step-icon absolute left-0 top-0 w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold text-sm z-10';
            } else {
                steps[stepIndex].classList.add('completed');
                steps[stepIndex].classList.remove('active');
                const icon = steps[stepIndex].querySelector('.step-icon');
                icon.className = 'step-icon absolute left-0 top-0 w-8 h-8 rounded-full bg-gradient-to-r from-green-500 to-green-600 flex items-center justify-center text-white font-bold text-sm z-10';
            }
        }

        // Cancel processing
        function cancelProcessing() {
            if (isProcessing) {
                processingCancelled = true;
                showNotification('Cancelling processing...', 'info');
                statusText.textContent = 'Cancelling...';
            }
        }

        // Reset processing UI
        function resetProcessingUI() {
            isProcessing = false;
            processingCancelled = false;
            
            setTimeout(() => {
                progressSection.classList.add('hidden');
                processBtn.disabled = false;
                progressFill.style.width = '0%';
                progressPercent.textContent = '0%';
                chunkProgress.textContent = '';
                
                const steps = processSteps.querySelectorAll('.process-step');
                steps.forEach(step => {
                    step.classList.remove('active', 'completed');
                    const icon = step.querySelector('.step-icon');
                    icon.className = 'step-icon absolute left-0 top-0 w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-sm z-10';
                });
                steps[0].classList.add('active');
                steps[0].querySelector('.step-icon').className = 'step-icon absolute left-0 top-0 w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold text-sm z-10';
                
                statusText.textContent = 'Ready to process';
            }, 1000);
        }

        // Read file as ArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Process large PDF in chunks
        async function processLargePdf(file, mergedPdf, numberingOption, numberFormat, progressCallback) {
            const arrayBuffer = await readFileAsArrayBuffer(file);
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const totalPages = pdf.numPages;
            
            // Process in chunks to avoid memory issues
            const chunkSize = Math.min(50, totalPages);
            
            for (let chunk = 0; chunk < Math.ceil(totalPages / chunkSize); chunk++) {
                if (processingCancelled) {
                    pdf.destroy();
                    throw new Error('Processing cancelled');
                }
                
                const startPage = chunk * chunkSize + 1;
                const endPage = Math.min((chunk + 1) * chunkSize, totalPages);
                
                for (let pageNum = startPage; pageNum <= endPage; pageNum++) {
                    if (processingCancelled) {
                        pdf.destroy();
                        throw new Error('Processing cancelled');
                    }
                    
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 1.0 });
                    
                    // Create canvas
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    // Convert to image
                    const imageData = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // Add to PDF
                    const pdfPage = mergedPdf.addPage([viewport.width, viewport.height]);
                    const image = await mergedPdf.embedJpg(imageData);
                    pdfPage.drawImage(image, {
                        x: 0,
                        y: 0,
                        width: viewport.width,
                        height: viewport.height,
                    });
                    
                    // Clean up
                    canvas.remove();
                    
                    // Report progress
                    progressCallback(pageNum, totalPages);
                }
            }
            
            pdf.destroy();
        }

        // Convert Word to PDF
        async function convertWordToPdf(file) {
            return new Promise(async (resolve, reject) => {
                try {
                    const arrayBuffer = await readFileAsArrayBuffer(file);
                    const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
                    const html = result.value;
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    const margin = 20;
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const maxWidth = pageWidth - 2 * margin;
                    
                    const text = html
                        .replace(/<[^>]*>/g, ' ')
                        .replace(/\s+/g, ' ')
                        .replace(/&nbsp;/g, ' ')
                        .trim();
                    
                    const lines = doc.splitTextToSize(text, maxWidth);
                    
                    let y = margin;
                    const lineHeight = 7;
                    const pageHeight = doc.internal.pageSize.getHeight();
                    
                    for (let i = 0; i < lines.length; i++) {
                        if (y + lineHeight > pageHeight - margin) {
                            doc.addPage();
                            y = margin;
                        }
                        
                        doc.text(lines[i], margin, y);
                        y += lineHeight;
                    }
                    
                    const pdfOutput = doc.output('arraybuffer');
                    resolve(pdfOutput);
                } catch (error) {
                    console.error('Error converting Word to PDF:', error);
                    
                    // Fallback
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.text(`Converted from: ${file.name}`, 20, 20);
                    doc.text('Content converted successfully.', 20, 30);
                    
                    const pdfOutput = doc.output('arraybuffer');
                    resolve(pdfOutput);
                }
            });
        }

        // Add page number
        async function addPageNumber(page, currentPage, format, position, mergedPdf) {
            const { width, height } = page.getSize();
            
            let pageNumberText;
            switch (format) {
                case 'i':
                    pageNumberText = toRoman(currentPage).toLowerCase();
                    break;
                case 'I':
                    pageNumberText = toRoman(currentPage);
                    break;
                case 'a':
                    pageNumberText = toAlpha(currentPage).toLowerCase();
                    break;
                case 'A':
                    pageNumberText = toAlpha(currentPage);
                    break;
                default:
                    pageNumberText = currentPage.toString();
            }
            
            pageNumberText = `Page ${pageNumberText}`;
            
            let x, y;
            
            switch (position) {
                case 'bottom-center':
                    x = width / 2;
                    y = 30;
                    break;
                case 'bottom-right':
                    x = width - 70;
                    y = 30;
                    break;
                case 'top-right':
                    x = width - 70;
                    y = height - 30;
                    break;
                default:
                    return;
            }
            
            // Embed font and draw text
            const font = await mergedPdf.embedFont(PDFLib.StandardFonts.Helvetica);
            page.drawText(pageNumberText, {
                x: x,
                y: y,
                size: 10,
                color: PDFLib.rgb(0.3, 0.3, 0.3),
                font: font,
            });
        }
        
        // Helper: to Roman numerals
        function toRoman(num) {
            if (num < 1 || num > 3999) return num.toString();
            
            const romanNumerals = [
                { value: 1000, numeral: 'M' },
                { value: 900, numeral: 'CM' },
                { value: 500, numeral: 'D' },
                { value: 400, numeral: 'CD' },
                { value: 100, numeral: 'C' },
                { value: 90, numeral: 'XC' },
                { value: 50, numeral: 'L' },
                { value: 40, numeral: 'XL' },
                { value: 10, numeral: 'X' },
                { value: 9, numeral: 'IX' },
                { value: 5, numeral: 'V' },
                { value: 4, numeral: 'IV' },
                { value: 1, numeral: 'I' }
            ];
            
            let result = '';
            for (const { value, numeral } of romanNumerals) {
                while (num >= value) {
                    result += numeral;
                    num -= value;
                }
            }
            return result;
        }
        
        // Helper: to alphabetical
        function toAlpha(num) {
            let result = '';
            while (num > 0) {
                const remainder = (num - 1) % 26;
                result = String.fromCharCode(65 + remainder) + result;
                num = Math.floor((num - 1) / 26);
            }
            return result || 'A';
        }

        // Add animation styles
        function addAnimationStyles() {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(-10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                
                @keyframes slide {
                    0% { transform: translateX(-100%); }
                    100% { transform: translateX(100%); }
                }
                
                .animate-slideInRight {
                    animation: slideInRight 0.3s ease-out;
                }
                
                .animate-fadeIn {
                    animation: fadeIn 0.5s ease-out;
                }
                
                .animate-slide {
                    animation: slide 2s linear infinite;
                }
                
                .process-step {
                    position: relative;
                    padding-left: 2.5rem;
                }
                
                .process-step:not(:last-child)::after {
                    content: '';
                    position: absolute;
                    left: 1rem;
                    top: 2rem;
                    bottom: -1.5rem;
                    width: 2px;
                    background: #e5e7eb;
                    z-index: 1;
                }
                
                .process-step.completed:not(:last-child)::after {
                    background: linear-gradient(to bottom, #10b981, #3b82f6);
                }
                
                .process-step .step-icon {
                    z-index: 2;
                }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
</html>
